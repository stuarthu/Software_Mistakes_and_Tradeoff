### 前言

软件交付工作充满了各种各样的取舍，这是参与其中的每个人都无法回避的挑战。我们经常面对有限的项目周期，捉襟见肘的预算，陌生的领域。因此，我们当下做出的任何一个软件设计决定都会对其未来产生影响，譬如系统维护的开销，软件需要变更时才暴露的僵化设计，需要扩展时才发现的性能瓶颈，诸如此类、林林总总的问题。我们必须认识到一点，即任何一个取舍都是特定条件的产物。我们很容易评判之前的设计在设计之初缺乏对上下文的充分了解。然而，设计时我们了解得越多，分析得越深入，我们对所做决定的利弊得失越胸有成竹。



我们亲自主持和参与了许多软件设计决策，对这些决策背后所隐含的权衡取舍逐渐熟稔于心。在此过程中，托马斯开始了个人决策日志的撰写，记录下我们当时做出某个决定时的具体情况。软件设计决策的背景是什么？有哪些替代方案？我们是如何评估某个特殊方案的？最后，我们最终采用了什么样的解决方案？对某个解决方案我们是否成功预测了所有可能的权衡利弊？还是我们对某些情况也感到惊讶？事实证明，这份个人经验教训清单所涵盖的内容也是许多软件工程师要解决的问题，需要面临的取舍。托马斯认为现在是一个与世界分享这些知识的绝佳时机。这就是这本书的由来。



通过本书，我们想分享我们从各种软件系统设计中收获的经验教训：单体系统、微服务、大数据处理、库的设计等等。这本书深入分析了现实生产系统设计中的决策、权衡和教训。通过介绍这些设计模式，错误的决策以及惨痛的教训，我们希望能帮助你拓宽视野，升级你的工具箱，帮助你在日常工作中做出更好的决策。提前发现软件设计中潜在的问题以及局限可以在未来帮你节省大量的时间和金钱。我们不会试图给你明确的答案。问题很复杂时，通常会有多种解决方法。我们将分享一些挑战性的问题，并提出一些没有明确答案的问题。每种解决方案都有其优缺点，我们会做针对性的分析。每选择一个解决方案也都需要做出取舍，您需要判断到底哪一个最适合您的实际情况。



### 致谢

写书是一件极其劳神费力的苦差事，感谢曼宁出版社，让它成为一段愉悦的经历。



首先，我要感谢我的妻子马戈扎塔。你一直支持我，倾听我的想法和问题。因为有了你的支持，我才能专心致志地写书。接下来，我要感谢我在曼宁的编辑道格·鲁德尔。谢谢你和我一起工作。你的意见和反馈非常宝贵。因为你的参与，我的写作技巧才得以更上一层楼。我要感谢曼宁和我一起为这本书的制作和推广辛勤工作的同事们。这本书的成功面世真的是团队协作的结晶。我还要特别感谢曼宁其他的工作人员: 我的制作编辑迪尔德丽·希亚姆; 我的文案编辑克里斯蒂安·伯克; 我的评论编辑米哈埃拉·巴蒂尼奇; 还有我的校对杰森·埃弗雷特。



我也要感谢书稿编写的不同阶段花时间阅读它的书评人，他们提供了宝贵的反馈——你们的建议让这本书变得更好：Alex Saez, Alexander Weiher, Andres Sacco, Andrew Eleneski, Andy Kirsch, Conor Redmond, Cosimo Atanasi, Dave Corun, George Thomas, Gilles Iachelini, Gregory Varghese, Hugo Cruz, Johannes Verwijnen, John Guthrie, John Henry Galino, Johnny Slos, Maksym Prokhorenko, Marc-Oliver Scheele, Nelson González, Oliver Korten, Paolo Brunasti, Rafael Avila Martinez, Rajesh Mohanan, Robert Trausmuth, Roberto Casadei, Sau Fai Fong, Shawn Lam, Spencer Marks, Vasile Boris, Vincent Delcoigne, Vitosh Doynov, Walter Stoneburner以及Will Price。

特别感谢开发编辑Jeanne Boyarsky，她从技术角度仔细审查了本书的内容。

这本书是截至目前我职业生涯的所有决定以及遇到的所有人共同作用的结果。感谢成长道路上给予我支持帮助的人们，他们将我塑造成了一位合格的软件工程师，并对我的职业生涯产生了积极的影响。我很幸运，从我的职业生涯开始，就遇到了这样的人，并与他们一起工作。我要感谢Schibsted、Allegro、DataStax和Dremio的所有同事。有些人值得特别感谢，他们是：

- Paweł Wołoszyn —— Paweł是一名大学讲师，他带我走进程序设计的世界并让我意识到编程对世界的巨大影响
- Andrzej Grzesik —— 鼓励我朝着远大的目标前进
- Mateusz Kwaśniewski —— 点燃了我对学习的无限渴望
- Łukasz Bancerowski —— 给了我最初的方向，为我的JVM职业生涯打下了坚实的基础
- Jarosław Pałka —— 提供了足够的信任和空间，让我有机会在试错中学习和成长
- Alexandre Dutra —— 以身作则，展示了最高标准的职业道德

—— Tomasz Lelek



我要感谢这些年来默默忍受我在时区话题上持续絮叨的读者们，尤其是我的家人们。我在谷歌公司的同事们，在`Noda Time`及其他开源项目在上的合作者们都对我在本书中介绍内容的形成居功至伟。

——  Jon Skeet



#### 关于本书 

《软件错误与权衡:如何做出良好的编程决策》提供了一系列设计生产系统时可能遭遇的现实问题。它试图对软件系统设计中可能出现的各种情况进行分析，并逐一解说每种决策的权衡取舍。本书也涵盖了一些并不常见的软件设计错误，这些有缺陷的设计会从多方面对你的系统造成恶劣的影响（不仅仅是程序的正确性）。



#### 本书面向的读者

《软件错误与权衡:如何做出良好的编程决策》适合于希望理解生产系统设计时的取舍与常见设计模式的软件工程师。本书也介绍了如何避免常见的设计缺陷。本书开篇从基础性的话题切入，对刚刚开启职业生涯的软件工程师而言，这些内容是大有裨益的。接着，我们会转入相对高层的话题，即便是有经验的程序开发者也能从中获益。本书使用的主要开发语言是Java，案例、模式以及代码片段都基于Java，不过软件设计的决策权衡并不局限于Java语言。



#### 本书的组织结构

本书共有13章。第一篇概述了本书中使用的权衡分析。其余各章相对独立，分别专注于软件工程的不同方面。为了从本书中获得最大的收益，我们建议您按照原始顺序阅读。但是，如果你对软件工程的某个方面感兴趣，你可以直接跳转到某个特定章节:

- 第1章介绍了本书分析权衡取舍时所采用的方法。我们会通过软件架构、代码以及质量保证方面的例子说明如何做权衡取舍。
- 第2章展示了代码重复并不一定是反模式。从不同的架构角度出发，分析代码重复如何对系统的松耦合或紧耦合造成影响。最后，使用Amdhal定律计算团队内部协调与跨团队协同的开销。
- 第3章描述了代码发生异常情况时的处理策略。我们会按照检查异常和未检查异常两类用例分别进行展开。本章还介绍了如何为公共API(库)设计异常策略。最后，我们探讨了面向对象的程序设计与函数式编程方法在错误处理时权衡与取舍。
- 第4章指导我们如何平衡代码以及`API`设计中的灵活性和复杂性。这表明，通常情况下，代码在一个方向上的演进会对其另一个方向的发展造成影响。
- 第5章告诉我们，在项目的早期开展优化并不总是坏事。使用适当的工具和定义恰当的SLA，我们可以发现代码路径中的热点并对其进行优化。此外，本章还演示了如何利用帕累托原则，帮助定位系统中适合进行优化的部分，从而将优化工作聚焦于此。
- 第6章介绍了如何设计对用户体验（UX）友好的API。通过本章介绍，我们会了解创建对用户体验友好的接口不仅是UI接口的事儿，也需要编程接口的支持，譬如REST API、命令行工具以及其他接口。然而，这也表明，为了良好的用户体验，我们需要付出更高的维护成本。
- 第7章讨论了如何处理日期和时间信息，这也是一个极其棘手的问题。想想我们的数据里有多少时间日期元素吧，譬如出生日期或者日志的时间戳，这些地方都极有可能出现错误。这并不是一个复杂的领域，但确实需要我们特别注意。
- 第8章介绍了为什么数据局部性在大数据处理中至关重要。本章同时还介绍了分配数据和流量的分区算法要满足哪些要求。
- 第9章介绍了我们使用的库成为了我们的代码。本章会讨论将第三方库导入到代码库时需要考虑的因素，可能引发的问题及权衡取舍。最后，本章试图回答一个问题：我们是否应该导入一个库还是重新实现它的一小部分。
- 第10章重点讨论设计分布式系统时一致性与原子性之间的权衡。本章分析了分布式系统中可能发生的竞争条件，并展示了幂等性是如何影响我们设计系统的方式的。
- 第11章介绍了如何处理分布式系统中的交付语义。本章内容可以帮助您理解分布式系统中“至少一次”、“最多一次”和“有效地恰好一次”的含义。
- 第12章介绍了软件、应用程序接口以及存储数据是如何随着时间的推移发展演进的。它们如何能在保持与其他系统的兼容性的同时做到这些。
- 第13章讨论了紧跟IT行业的最新趋势可能并不总是明智的选择。本章分析了一些广泛使用的模式和框架，譬如响应式编程，也对这些技术在某些特定场景的适用性进行了讨论。



#### 关于本书的代码 

本书中包含了大量的代码示例，有的是以数字标注行号的代码清单，另一些则是以普通文本的方式呈现的。无论哪种情况，源代码都是以**这样字体的定长文本**方式进行格式化，将其与普通文本区分开来。有些时候代码会被**加粗**从而区分出该章节的代码与之前的代码之间的区别，譬如，对一行现存代码进行修改增加了新的功能。



很多时候，原始代码会被重新格式化；我们会添加换行符或者对代码进行重构，引入代码缩进以适配页面的可用空间。即便如此，还是有一些极端的情况，代码清单中会包含行连续标记（➥）。此外，如果代码在章节正文中有介绍，源代码中的注解会被移除。



本书包含了大量的源代码示例，既有以行号标注的代码清单，也有简短的代码片段。源代码根据谷歌代码指南使用自动化插件进行了格式化。许多代码清单都附有代码注释，对重要的概念进行强调。代码仓库中每个章节都拥有一个单独的文件夹。为了保证代码质量，本书使用的所有代码都有大量的单元测试和集成测试。但并不是所有的测试都在本书的代码清单中进行了展示。您可以阅读并运行这些测试从而更深入地理解某部分的逻辑。通过阅读代码仓库中的`README.md`文件，您可以了解如何导入并运行这些例子。



你可以通过 https://livebook.manning.com/book/software-mistakes-and-tradeoffs在本书的liveBook(在线版本)上找到可执行的代码片段。书中示例的完整代码可从Manning网站https://www.manning.com/books/software-mistakes-and-tradeoffs和https://github.com/tomekl007/manning下载。



#### 在线阅读论坛 

购买《软件错误与权衡:如何做出良好的编程决策》的同时，您也获得了该书在曼宁出版社的在线阅读平台上的免费访问权限。利用在线阅读平台独一无二的讨论功能，您可以为该书添加全局注释，或对某一章节或是段落的注解。这是您为自己创建的一份带注解的快照，您可以询问或者回答技术问题，也可以向作者或者其他人寻求帮助。您可以通过https://livebook.manning.com/book/software-mistakes-and-tradeoffs/discussion访问该论坛。通过https://livebook.manning.com/discussion您可以进一步了解曼宁出版社的在线阅读平台及其相关规则。

曼宁出版社致力于为我们的读者提供一个开放的空间，方便读者之间，读者群之间，读者与作者之间开展有意义的交流。我们并未对作者在阅读平台上的参与程度做任何承诺，他们对论坛的贡献是自愿且无偿的。我们建议您试着问一些挑战性的问题，从而激发他们参与讨论的兴趣。只要这本书还在印刷，您就依然能从出版网站上访问论坛及之前讨论的存档。



#### 关于作者 

**Tomasz Lelek**

在他的软件开发职业生涯里，Tomasz设计开发过各种各样的生产服务，软件架构，精通多种编程语言（大多数是基于JVM的）。他既实现过单体系统，也曾工作于微服务架构。他设计的系统需要服务数千万用户，每秒处理数十万的操作。他的工作经历涵盖：

- 采用`CQRS`架构的微服务（基于`Apache Kafka`）
- 市场自动化及事件流处理
- 基于`Apache Spark`和`Scala`的大数据处理

Tomasz现在服务于Dremio, 负责创建现代大数据处理的数据湖解决方案。在此之前，他在DataStax，负责`Cassandra`数据库相关的一些列产品。他设计的工具帮助了成千上万的开发者设计出性能优异，用户友好的API，在其中发挥了重要的作用。他为Java-Driver, Cassandra Quarkus, Cansandra-Kafka Connector以及Stargate都贡献过代码。



**Jon Skeet**

Jon是谷歌公司的资深开发者工程师，目前的工作方向是谷歌云的`.NET`客户端库。他向开源社区贡献了`.NET`版本的`Noda`时间日期库（https://nodatime.org），然而他最让人称道的原因却是他在`Stack Overflow`开发者社区的贡献。Jon是曼宁出版社出版的《C# in Depth》一书的作者，此外，他还对《Groovy实战》以及《函数式编程实战》有所贡献。Jon对时间日期API以及API版本非常感兴趣，这些通常是无人问津的冷门话题。																																			

#### 关于本书的封面插图

《软件错误与权衡:如何做出良好的编程决策》封面上的人物是“Groenlandaisse”，或“来自格陵兰的女人”，摘自Jacques Grasset de Saint-Sauveur于1797年出版的作品集。每幅插图都经由手工绘制和上色。在那个年代，仅凭一个人的穿着，就可以很容易地推断出他们住在哪里，从事什么职业或在生活中处于什么地位。曼宁以几个世纪前丰富多样的地方文化作为书籍的封面，赞颂计算机行业的创造力和开创精神，本书使用的这一张就来自于这些图片收藏，它们让我们得以重温那些时刻。